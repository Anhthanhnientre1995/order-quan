<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quáº£n lÃ½ Order QuÃ¡n</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial,sans-serif;margin:0;padding:10px}
h2,h3{margin:10px 0}
button{cursor:pointer}
body{-webkit-text-size-adjust:100%;}
html,body{touch-action:manipulation;}
/* TÃ´ mÃ u RIÃŠNG CHO NÃšT "NÆ°á»›c riÃªu" - CHá»ˆ NHÃ“M 25.000Ä‘ */
.menu-group-block:first-of-type .menu-items button:first-child {
  background: #ffb366 !important; /* Cam nháº¡t riÃªu cua */
  color: #333 !important; /* Chá»¯ tá»‘i dá»… Ä‘á»c */
  border-color: #ff8c00 !important;
  font-weight: bold !important; /* In Ä‘áº­m ná»•i báº­t */
}

/* Khi báº¥m nÃºt váº«n highlight Ä‘áº¹p */
.menu-group-block:first-of-type .menu-items button:first-child:active {
  background: #ffda99 !important;
  border-color: #e67e22 !important;
}
/* iPad TOUCH OPTIMIZATION */
@media (hover:none) and (pointer:coarse){
  .menu-items button{font-size:26px;padding:18px;border-radius:10px;}
  .table-btn{font-size:26px;padding:16px 0;}
  .btn{font-size:22px;padding:16px;border-radius:8px;}
  input[type="checkbox"]{width:26px;height:26px;}
  .order li{font-size:22px;}
}

/* layout */
.wrapper{display:flex;gap:10px;height:calc(100vh - 80px);}
.left{flex:2.8;overflow-y:auto;}
.mid{flex:2;overflow-y:auto;}
.right{flex:1;border-left:2px solid #ccc;padding-left:10px;overflow-y:auto;}

/* BÃ€N */
.tables{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.table-btn{
  flex:1 0 22%;
  font-size:28px;font-weight:600;padding:16px 0;
  border:3px solid #999;background:#fff;border-radius:8px;
}
.table-btn.active{border:4px solid #2ecc71;background:#eafff1}
.table-btn.selected{border:4px solid #3498db;background:#d9f2ff}
.warn{background:#fff3cd}
.danger{background:#f8d7da}
.super-danger{background:#ffcccc}

/* mang vá» */
.btn-takeaway{
  font-size:22px;padding:10px 16px;margin:8px 0;
}

/* MENU */
.menu-group-block{margin-bottom:25px;}
.menu-price{margin:20px 0 10px;font-size:22px;font-weight:bold;border-bottom:2px solid #ddd;padding-bottom:4px;}
.menu-items{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.menu-items button{
  font-size:24px;font-weight:600;padding:16px 14px;
  border-radius:10px;border:2px solid #333;background:#f5f5f5;
  text-align:center;line-height:1.2;
}
.menu-items button:active{background:#d9f2ff;border-color:#0077cc;}

/* order */
.order li{
  display:flex;justify-content:space-between;align-items:center;
  font-size:20px;margin:5px 0;
}
.order-left{display:flex;gap:5px;align-items:center;}
.done{text-decoration:line-through;color:#777}
.longest{font-weight:bold;color:#b30000}
.del{color:red;font-weight:bold;margin-left:4px}

/* thanh toÃ¡n */
.payment-box{
  background:#f7dede;padding:12px;border-radius:6px;text-align:center;
  position:sticky;bottom:0;z-index:5;
}
.bill-title{font-size:18px;margin-bottom:6px}
.bill-total{font-size:44px;font-weight:bold;margin-bottom:12px;color:#c0392b;}
.btn{
  width:100%;font-size:22px;padding:14px;margin:6px 0;
  border:none;color:white;border-radius:6px;
}
.btn.pay{background:#7a0c00}
.btn.undo,.btn.print{background:#555}
.btn.stats{background:#3b6ee3}
.btn.excel{background:#2e7d32}
.btn.close{background:#000}
.btn.discount{background:#8e44ad}
.btn.clear{background:#c0392b}
.btn.merge{background:#2980b9}
.btn.merge.active{background:#1abc9c}

/* hoáº¡t Ä‘á»™ng */
.active-list li{font-size:19px;margin:5px 0;cursor:pointer;line-height:1.4;}

/* lá»‹ch sá»­ */
.history{max-height:500px;overflow:auto;border-top:1px solid #ccc;margin-top:10px}
.history > div{
  margin-bottom:30px;padding-bottom:15px;border-bottom:1px dashed #ccc;
  font-size:24px;line-height:1.6;
}
.history b{font-size:26px;}

/* popup */
#overlay{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;
  background:rgba(0,0,0,0.6);z-index:999999;justify-content:center;align-items:center;}
#popup{background:#fff;padding:20px;max-height:90%;overflow:auto;border-radius:12px;width:90%;max-width:500px;}
</style>
</head>

<body>

<!-- POPUP -->
<div id="overlay">
  <div id="popup">
    <button onclick="closePopup()" style="font-size:20px;margin-bottom:10px;width:100%;padding:12px;background:#333;color:white;border:none;border-radius:8px;">
      ÄÃ“NG
    </button>
    <div id="popupContent"></div>
  </div>
</div>

<h2>QUáº¢N LÃ ORDER QUÃN</h2>

<div class="wrapper">

<div class="left">
<h3>BÃ€N</h3>
<div class="tables" id="tables"></div>
<button class="btn-takeaway" onclick="addTakeaway()">+ MANG Vá»€</button>

<h3>MENU</h3>
<div id="menu"></div>
</div>

<div class="mid">
<h3>ORDER: <span id="current">---</span> <span id="startTime" style="font-size:16px;color:#555;"></span></h3>
<ul class="order" id="orderList"></ul>

<button class="btn clear" onclick="clearCurrentOrder()">XÃ“A TOÃ€N Bá»˜ ORDER</button>
<button class="btn merge" onclick="toggleMergeMode()" id="mergeBtn">Gá»˜P ÄÆ N</button>
</div>

<div class="right">
<div class="payment-box">
  <div class="bill-title">ÄÆ¡n: <span id="currentBox">---</span></div>
  <div class="bill-total" id="total">0 Ä‘</div>
  <div style="font-size:22px;margin:10px 0;" id="discountAmount">Chiáº¿t kháº¥u: 0Ä‘</div>

  <button class="btn discount" onclick="applyDiscount()">ÃP Dá»¤NG CHIáº¾T KHáº¤U</button>
  <button class="btn pay" onclick="pay()">THANH TOÃN</button>
  <button class="btn undo" onclick="undoPay()">LÃ€M Láº I</button>
  <button class="btn print" onclick="printBill()">IN ÄÆ N</button>
  <button class="btn stats" onclick="showStats()">XEM THá»NG KÃŠ NGÃ€Y</button>
  <button class="btn excel" onclick="exportExcel()">XUáº¤T EXCEL</button>
  <button class="btn close" onclick="closeDay()">CHá»T CUá»I NGÃ€Y</button>
</div>

<h3>BÃ€N / ÄÆ N ÄANG HOáº T Äá»˜NG</h3>
<ul class="active-list" id="activeList"></ul>

<h3>Lá»ŠCH Sá»¬ ÄÃƒ THANH TOÃN</h3>
<div class="history" id="history"></div>
</div>
</div>

<script>
/* ===== DATA ===== */
const tables=["B1","B2","B3","B4","B5","B6","B7","B8","B9","B10","B11","B12"];

const menuData=[
 ["25.000Ä‘","NÆ°á»›c riÃªu",0],  // ÄÆ°a lÃªn Ä‘áº§u nhÃ³m 25k
 ["","Cháº£ thÆ°á»ng",25000],["","Cháº£ quáº¡t",25000],["","Cháº£ lÃ¡ lá»‘t",25000],
 ["","Má»c",25000],["","LÃ²ng",25000],["","RiÃªu cua",25000],["","MÃ¬ tÃ´m",25000],
 ["","BÃºn20",25000],["","TH30",25000],["","TH40",25000],["","TH50",25000],

 ["20.000Ä‘","ChÃ¡o",20000],["","Tiáº¿t canh",20000],
 ["15.000Ä‘","Thuá»‘c lÃ¡",15000],["","Bia",15000],["","RÆ°á»£u",15000],["","BÃ² HÃºc",15000],
 ["10.000Ä‘","Coca",10000],

 ["ÄÄ©a lÃ²ng","ÄÄ©a lÃ²ng 10k",10000],["","ÄÄ©a lÃ²ng 30k",30000],
 ["","ÄÄ©a lÃ²ng 50k",50000],["","ÄÄ©a lÃ²ng 100k",100000],

 ["YÃªu cáº§u Ä‘áº·c biá»‡t","Bá» hÃ nh",0],["","Bá» gan",0],["","Bá» dáº¡ dÃ y",0],
 ["","Bá» lÃ²ng",0],["","Bá» phá»•i",0],["","Chá»‰ láº¥y lÃ²ng",0],["","Chá»‰ láº¥y dáº¡ dÃ y",0],

 ["ThÃªm topping (+5k)","+ Cháº£ lÃ¡ lá»‘t",5000],["","+ Cháº£ nÆ°á»›ng",5000],
 ["","+ LÃ²ng",5000],["","+ Dáº¡ dÃ y",5000]
];

let orders=JSON.parse(localStorage.getItem("orders")||"{}");
let history=JSON.parse(localStorage.getItem("history")||"[]");
let sold=JSON.parse(localStorage.getItem("sold")||"[]");
let takeaway=Number(localStorage.getItem("takeaway")||0);
let discounts = JSON.parse(localStorage.getItem("discounts")||"{}");
let current="", lastPay=null;
let mergeMode = false;
let selectedSources = [];

function save(){
  localStorage.setItem("orders",JSON.stringify(orders));
  localStorage.setItem("history",JSON.stringify(history));
  localStorage.setItem("sold",JSON.stringify(sold));
  localStorage.setItem("takeaway",takeaway);
  localStorage.setItem("discounts",JSON.stringify(discounts));
}

/* MENU INIT - Táº¤T Cáº¢ MÃ“N Báº¤M LÃ€ THÃŠM LUÃ”N */
const menuDiv=document.getElementById("menu");
let groupBlock=null,lastGroup="";
menuData.forEach(m=>{
  if(m[0] && m[0]!==lastGroup){
    groupBlock=document.createElement("div");
    groupBlock.className="menu-group-block";
    const title=document.createElement("div");
    title.className="menu-price";
    title.innerText=m[0];
    const items=document.createElement("div");
    items.className="menu-items";
    groupBlock.appendChild(title);
    groupBlock.appendChild(items);
    menuDiv.appendChild(groupBlock);
    lastGroup=m[0];
  }
  const b=document.createElement("button");
  b.innerText=m[1];
  b.onclick=()=>addItem(m[1],m[2]);
  groupBlock.querySelector(".menu-items").appendChild(b);
});

/* ThÃªm mÃ³n */
function addItem(name, price){
  if(!current) return alert("ChÆ°a chá»n bÃ n/Ä‘Æ¡n");
  orders[current]=orders[current]||[];
  orders[current].push({name, price, done:false, time:Date.now()});
  save(); render();
}

/* Gá»˜P ÄÆ N */
function toggleMergeMode(){
  mergeMode = !mergeMode;
  selectedSources = [];
  const btn = document.getElementById("mergeBtn");
  btn.classList.toggle("active", mergeMode);
  btn.innerText = mergeMode ? "Há»¦Y Gá»˜P" : "Gá»˜P ÄÆ N";
  renderTables();
}

function handleTableClick(t){
  if(!mergeMode){
    select(t);
    return;
  }
  if(selectedSources.includes(t)){
    selectedSources = selectedSources.filter(x=>x!==t);
  }else{
    selectedSources.push(t);
  }
  if(selectedSources.length >= 1 && current !== t && orders[t]?.length){
    let dest = current || t;
    if(!confirm(`Gá»™p ${selectedSources.join(", ")} vÃ o ${dest}?`)) {
      selectedSources = [];
    }else{
      selectedSources.forEach(src=>{
        if(src !== dest && orders[src]){
          orders[dest] = (orders[dest]||[]).concat(orders[src]);
          if(discounts[src]) {
            discounts[dest] = (discounts[dest]||0) + discounts[src];
            delete discounts[src];
          }
          delete orders[src];
        }
      });
      selectedSources = [];
      toggleMergeMode();
      select(dest);
      save();
    }
  }
  renderTables();
}

/* RENDER TABLES */
const tablesDiv=document.getElementById("tables");
function renderTables(){
  tablesDiv.innerHTML="";
  tables.forEach(t=>{
    const b=document.createElement("button");
    b.className="table-btn"; b.innerText=t;
    if(orders[t]?.length){
      const mins = waitMin(t);
      if(mins>=10) b.classList.add("super-danger");
      else if(mins>=5) b.classList.add("danger");
    }
    if(current===t) b.classList.add("active");
    if(selectedSources.includes(t)) b.classList.add("selected");
    b.onclick=()=>handleTableClick(t);
    tablesDiv.appendChild(b);
  });
  Object.keys(orders).filter(t=>t.startsWith("MV")).forEach(t=>{
    const b=document.createElement("button");
    b.className="table-btn warn"; b.innerText=t;
    if(current===t) b.classList.add("active");
    if(selectedSources.includes(t)) b.classList.add("selected");
    b.onclick=()=>handleTableClick(t);
    tablesDiv.appendChild(b);
  });
}

const orderList=document.getElementById("orderList"),
      totalDiv=document.getElementById("total"),
      discountAmount=document.getElementById("discountAmount"),
      currentSpan=document.getElementById("current"),
      currentBox=document.getElementById("currentBox"),
      startTimeDiv=document.getElementById("startTime");

function select(t){
  current=t;
  render();
}

function waitMin(t){
  const items = orders[t]||[];
  if(items.length===0) return 0;
  return Math.floor((Date.now() - items[0].time)/60000);
}

function render(){
  orderList.innerHTML="";
  let sum=0;
  const items = orders[current]||[];
  items.forEach((o,i)=>{
    sum += o.price;
    const li=document.createElement("li");
    li.innerHTML=`
      <div class="order-left">
        ${i+1}. <input type="checkbox" ${o.done?"checked":""} onchange="toggleDone(${i})">
        ${o.name}
        <span class="del" onclick="delItem(${i})">âŒ</span>
      </div>
      <div>${o.price.toLocaleString()}Ä‘</div>`;
    orderList.appendChild(li);
  });

  const disc = discounts[current] || 0;
  discountAmount.innerText = "Chiáº¿t kháº¥u: " + disc.toLocaleString() + "Ä‘";
  totalDiv.innerText = (sum - disc).toLocaleString() + " Ä‘";

  currentSpan.innerText=current||"---";
  currentBox.innerText=current||"---";

  if(items.length>0){
    const firstTime = new Date(items[0].time);
    startTimeDiv.innerText = "Báº¯t Ä‘áº§u: " + firstTime.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});
  }else{
    startTimeDiv.innerText="";
  }

  renderActive(); renderHistory(); renderTables();
}

function toggleDone(i){ orders[current][i].done=!orders[current][i].done; save(); render(); }
function delItem(i){ if(confirm("XÃ³a mÃ³n nÃ y?")){ orders[current].splice(i,1); save(); render(); } }
function clearCurrentOrder(){
  if(confirm("XÃ“A TOÃ€N Bá»˜ order cá»§a " + current + "?")){
    orders[current]=[]; delete discounts[current]; save(); render();
  }
}

const activeList=document.getElementById("activeList");
function renderActive(){
  activeList.innerHTML="";
  Object.keys(orders).sort().forEach(t=>{
    if(!orders[t].length) return;
    const sum=orders[t].reduce((a,b)=>a+b.price,0);
    const disc = discounts[t]||0;
    const final = sum - disc;
    const mins = waitMin(t);
    activeList.innerHTML+=`<li onclick="select('${t}')">${t} | â±ï¸ ${mins}p | ğŸª‘ ${mins}p | ğŸ’° ${final.toLocaleString()}Ä‘</li>`;
  });
}

function pay(){
  if(!current || !orders[current]?.length) return alert("ChÆ°a cÃ³ order");
  const items = [...orders[current]];
  const disc = discounts[current]||0;
  const sum = items.reduce((a,b)=>a+b.price,0);
  const final = sum - disc;

  lastPay={table:current, items, discount:disc};
  history.unshift({table:current, time:new Date().toLocaleTimeString(), items, discount:disc, total:final});
  sold.push(...items);
  if(current.startsWith("MV")) delete orders[current];
  else orders[current]=[];
  delete discounts[current];
  current="";
  save(); render();
}

function undoPay(){
  if(!lastPay) return alert("KhÃ´ng cÃ³ thanh toÃ¡n nÃ o Ä‘á»ƒ hoÃ n tÃ¡c");
  orders[lastPay.table] = lastPay.items;
  if(lastPay.discount) discounts[lastPay.table] = lastPay.discount;
  current = lastPay.table;
  lastPay=null;
  save(); render();
}

const historyDiv=document.getElementById("history");
function renderHistory(){
  historyDiv.innerHTML="";
  history.forEach(h=>{
    const sum=h.items.reduce((a,b)=>a+b.price,0);
    historyDiv.innerHTML+=`<div><b>${h.time} â€“ ${h.table}</b> ${h.discount?`(CK: ${h.discount.toLocaleString()}Ä‘)`:""}<br>
      ${h.items.map(i=>i.name + " " + i.price.toLocaleString()+"Ä‘").join("<br>")}
      <br><b>Tá»•ng: ${h.total.toLocaleString()}Ä‘</b></div>`;
  });
}

function printBill(){
  if(!current || !orders[current]?.length) return alert("ChÆ°a cÃ³ order");
  let html=`<html><head><meta charset="UTF-8"><style>body{font-family:Arial;padding:20px}h2{text-align:center}.item{margin:8px 0;font-size:20px;display:flex;justify-content:space-between}.total{font-size:26px;font-weight:bold;margin-top:20px;text-align:right}</style></head><body><h2>HÃ“A ÄÆ N ${current}</h2>`;
  let sum=0;
  orders[current].forEach(o=>{
    sum+=o.price;
    html+=`<div class="item"><span>${o.name}</span><span>${o.price.toLocaleString()}Ä‘</span></div>`;
  });
  const disc = discounts[current]||0;
  if(disc>0) html+=`<div class="item"><span>Chiáº¿t kháº¥u</span><span>-${disc.toLocaleString()}Ä‘</span></div>`;
  html+=`<div class="total">Tá»”NG: ${(sum-disc).toLocaleString()}Ä‘</div><script>window.print();window.onafterprint=()=>window.close();<\/script></body></html>`;
  const w=window.open("","_blank");
  w.document.write(html); w.document.close();
}

function applyDiscount(){
  if(!current) return alert("ChÆ°a chá»n bÃ n");
  let input = prompt("Nháº­p chiáº¿t kháº¥u:\n- Nháº­p sá»‘ tiá»n (vÃ­ dá»¥: 10000)\n- Hoáº·c % (vÃ­ dá»¥: 10%)", "");
  if(input===null || input==="") return;
  let disc=0;
  if(input.endsWith("%")){
    const percent = parseFloat(input);
    if(isNaN(percent)) return alert("Sai Ä‘á»‹nh dáº¡ng");
    const sum = (orders[current]||[]).reduce((a,b)=>a+b.price,0);
    disc = Math.round(sum * percent / 100);
  }else{
    disc = parseInt(input.replace(/\D/g,""))||0;
  }
  discounts[current] = disc;
  save(); render();
}

function showStats(){
  if(!sold.length){ showPopup("<h2>ChÆ°a cÃ³ dá»¯ liá»‡u trong ngÃ y</h2>"); return; }
  let total=0, map={};
  sold.forEach(item=>{
    if(!map[item.name]) map[item.name]={qty:0,money:0};
    map[item.name].qty++; map[item.name].money+=item.price;
    total+=item.price;
  });
  let html="<h2>THá»NG KÃŠ NGÃ€Y</h2>";
  for(const name in map){
    html+=`<div>${name}: ${map[name].qty} â†’ ${map[name].money.toLocaleString()}Ä‘</div>`;
  }
  html+=`<hr><h1>Tá»”NG DOANH THU: ${total.toLocaleString()}Ä‘</h1>`;
  showPopup(html);
}

function exportExcel(){
  if(!history.length){alert("ChÆ°a cÃ³ dá»¯ liá»‡u");return;}
  let summary={},rows1=[["MÃ³n","Sá»‘ lÆ°á»£ng","Tá»•ng tiá»n"]];
  sold.forEach(i=>{
    summary[i.name]=summary[i.name]||{q:0,t:0};
    summary[i.name].q++; summary[i.name].t+=i.price;
  });
  Object.keys(summary).forEach(k=>rows1.push([k,summary[k].q,summary[k].t]));
  let rows2=[["Thá»i gian","BÃ n","MÃ³n","GiÃ¡"]];
  history.forEach(h=>{
    h.items.forEach(i=>{
      rows2.push([h.time,h.table,i.name,i.price]);
    });
  });
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows1),"TongHop");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows2),"DonHang");
  XLSX.writeFile(wb,`order-${new Date().toISOString().slice(0,10)}.xlsx`);
}

function closeDay(){
  if(!confirm("Chá»‘t cuá»‘i ngÃ y? ToÃ n bá»™ dá»¯ liá»‡u ngÃ y sáº½ bá»‹ xÃ³a!")) return;
  orders={}; history=[]; sold=[]; takeaway=0; discounts={};
  save(); render();
}

function addTakeaway(){
  takeaway++;
  const id="MV"+String(takeaway).padStart(2,"0");
  orders[id]=[];
  save(); select(id);
}

function showPopup(html){
  document.getElementById("popupContent").innerHTML=html;
  document.getElementById("overlay").style.display="flex";
}

function closePopup(){
  document.getElementById("overlay").style.display="none";
}

renderTables(); render();
setInterval(renderTables,60000);
document.addEventListener('gesturestart', e=>e.preventDefault());
</script>

</body>
</html>
