<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω Order Qu√°n</title>
<meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               maximum-scale=1.0,
               user-scalable=no">


<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial,sans-serif;margin:0;padding:12px}
h2,h3{margin:12px 0}
button{cursor:pointer}
body{
  -webkit-text-size-adjust: 100%;
}
html, body {
  touch-action: manipulation;
}

/* ===== iPad TOUCH OPTIMIZATION ===== */
@media (hover: none) and (pointer: coarse) {

  /* N√∫t MENU */
  .menu-items button{
    font-size:36px;
    padding:28px;
    border-radius:18px;
  }

  /* N√∫t B√ÄN */
  .table-btn{
    font-size:48px;
    padding:34px 0;
  }

  /* N√∫t THANH TO√ÅN */
  .btn{
    font-size:32px;
    padding:24px;
    border-radius:12px;
  }

  /* Checkbox order */
  input[type="checkbox"]{
    width:28px;
    height:28px;
  }

  /* Danh s√°ch order */
  .order li{
    font-size:30px;
  }

}

/* layout */
.wrapper{display:flex;gap:12px}
.left{flex:2}
.mid{flex:2}
.right{flex:1;border-left:2px solid #ccc;padding-left:12px}

/* b√†n */
.tables{display:flex;flex-wrap:wrap;gap:10px}
.table-btn{
  flex:1 0 30%;
  font-size:42px;
  font-weight:600;
  padding:28px 0;
  border:3px solid #999;
  background:#fff;
}
.table-btn.active{border:4px solid #2ecc71;background:#eafff1}
.warn{background:#fff3cd}
.danger{background:#f8d7da}

/* mang v·ªÅ */
.btn-takeaway{
  font-size:30px;
  padding:14px 20px;
  margin:12px 0 20px;
}

/* ===== MENU ===== */
.menu-group-block{
  margin-bottom: 40px;
}

.menu-price{
  margin-top: 32px;
  margin-bottom: 16px;
  font-size: 30px;
  font-weight: bold;
  border-bottom: 2px solid #ddd;
  padding-bottom: 6px;
}

.menu-items{
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;                /* ‚úÖ KHO·∫¢NG C√ÅCH N√öT */
}

.menu-items button{
  font-size: 32px;          /* ‚úÖ FONT TO */
  font-weight: 600;
  padding: 28px 24px;
  border-radius: 18px;
  border: 2px solid #333;
  background: #f5f5f5;
  text-align: center;
  line-height: 1.25;
}

.menu-items button:active{
  background:#d9f2ff;
  border-color:#0077cc;
}

/* ===== iPad C·∫¢M ·ª®NG ===== */
@media (hover: none) and (pointer: coarse){
  .menu-items{
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;              /* ‚úÖ R·ªòNG H∆†N CHO NG√ìN TAY */
  }

  .menu-items button{
    font-size: 30px;
    padding: 28px 24px;
  }
}

/* ===== iPad D·ªåC / MOBILE ===== */
@media (max-width: 900px){
  .menu-items{
    grid-template-columns: repeat(2, 1fr);
  }
}


/* order */
.order li{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:26px;
  margin:8px 0;
}
.order-left{display:flex;gap:8px;align-items:center}
.done{text-decoration:line-through;color:#777}
.longest{font-weight:bold;color:#b30000}
.del{color:red;font-weight:bold;margin-left:6px}

/* thanh to√°n */
.payment-box{
  background:#f7dede;
  padding:20px;
  border-radius:6px;
  text-align:center;
  position:sticky;
  bottom:0;
}
.bill-title{font-size:22px;margin-bottom:10px}
.bill-total{font-size:56px;font-weight:bold;margin-bottom:20px}
.btn{
  width:100%;
  font-size:28px;
  padding:18px;
  margin:10px 0;
  border:none;
  color:white;
}
.btn.pay{background:#7a0c00}
.btn.undo,.btn.print{background:#555}
.btn.stats{background:#3b6ee3}
.btn.excel{background:#2e7d32}
.btn.close{background:#000}

/* danh s√°ch ho·∫°t ƒë·ªông */
.active-list li{font-size:24px;margin:8px 0;cursor:pointer}

/* l·ªãch s·ª≠ */
.history{max-height:260px;overflow:auto;border-top:1px solid #ccc;margin-top:10px}

/* popup */
#overlay{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  background:rgba(0,0,0,0.6);
  z-index:999999;
  justify-content:center;
  align-items:center;
}

#popup{
  background:#fff;
  padding:20px;
  max-height:90%;
  overflow:auto;
}


/* iPad ngang + laptop */
@media (min-width: 901px) and (max-width: 1200px) and (orientation: landscape) {
  .wrapper {
    flex-direction: row;
  }

  .left  { flex: 2.2; }
  .mid   { flex: 2; }
  .right { flex: 1.2; }

  .menu-items{
    grid-template-columns: repeat(3, 1fr);
  }
}

/* iPad d·ªçc + mobile */
@media (max-width: 900px) and (orientation: portrait) {
  .wrapper {
    flex-direction: column;
  }

  .right {
    order: -1;
    position: sticky;
    top: 0;
  }

  .menu-items{
    grid-template-columns: repeat(2, 1fr);
  }
}

}

</style>
</head>
<!-- POPUP -->
<div id="overlay">
  <div id="popup">
    <button onclick="closePopup()" style="font-size:20px;margin-bottom:10px">
      ƒê√ìNG
    </button>
    <div id="popupContent"></div>
  </div>
</div>

<body>



<h2>QU·∫¢N L√ù ORDER QU√ÅN</h2>

<div class="wrapper">

<div class="left">
<h3>B√ÄN</h3>
<div class="tables" id="tables"></div>
<button class="btn-takeaway" onclick="addTakeaway()">+ MANG V·ªÄ</button>

<h3>MENU</h3>
<div id="menu"></div>
</div>

<div class="mid">
<h3>ORDER: <span id="current">---</span></h3>
<ul class="order" id="orderList"></ul>
</div>

<div class="right">

<div class="payment-box">
  <div class="bill-title">ƒê∆†N: <span id="currentBox">---</span></div>
  <div class="bill-total" id="total">0 ƒë</div>

  <button class="btn pay" onclick="pay()">THANH TO√ÅN</button>
  <button class="btn undo" onclick="undoPay()">L√ÄM L·∫†I</button>
  <button class="btn print" onclick="printBill()">IN ƒê∆†N</button>
<button class="btn stats" onclick="showStats()">
  XEM TH·ªêNG K√ä NG√ÄY
</button>

  <button class="btn excel" onclick="exportExcel()">XU·∫§T EXCEL</button>
  <button class="btn close" onclick="closeDay()">CH·ªêT CU·ªêI NG√ÄY</button>
</div>

<h3>B√ÄN / ƒê∆†N ƒêANG HO·∫†T ƒê·ªòNG</h3>
<ul class="active-list" id="activeList"></ul>

<h3>L·ªäCH S·ª¨ ƒê√É THANH TO√ÅN</h3>
<div class="history" id="history"></div>

</div>
</div>

<script>
/* ===== DATA ===== */
const tables=["B1","B2","B3","B4","B5","B6","B7","B8","B9"];
const menuData=[
 ["25.000ƒë","ch·∫£ th∆∞·ªùng",25000],["","ch·∫£ qu·∫°t",25000],["","ch·∫£ l√° l·ªët",25000],
 ["","B√∫n m·ªçc",25000],["","B√∫n l√≤ng",25000],["","ri√™u cua",25000],["","M√¨ t√¥m",25000],
 ["20.000ƒë","Ch√°o",20000],["","Ti·∫øt canh",20000],
 ["15.000ƒë","Thu·ªëc l√°",15000],["","Bia",15000],["","R∆∞·ª£u",15000],["","B√≤ H√∫c",15000],
 ["10.000ƒë","Coca",10000],
 ["Kh√°c","Mix 30k",30000],
 ["","ƒêƒ©a l√≤ng 100k",100000],["","ƒêƒ©a l√≤ng 150k",150000],["","ƒêƒ©a l√≤ng 200k",200000]
];

let orders=JSON.parse(localStorage.getItem("orders")||"{}");
let history=JSON.parse(localStorage.getItem("history")||"[]");
let sold=JSON.parse(localStorage.getItem("sold")||"[]");
let takeaway=Number(localStorage.getItem("takeaway")||0);
let current="", lastPay=null;

/* ===== MENU INIT (ƒê√É CHIA NH√ìM GI√Å) ===== */
const menuDiv=document.getElementById("menu");
let groupBlock=null,lastGroup="";
menuData.forEach(m=>{
  if(m[0] && m[0]!==lastGroup){
    groupBlock=document.createElement("div");
    groupBlock.className="menu-group-block";
    const title=document.createElement("div");
    title.className="menu-price";
    title.innerText=m[0];
    const items=document.createElement("div");
    items.className="menu-items";
    groupBlock.appendChild(title);
    groupBlock.appendChild(items);
    menuDiv.appendChild(groupBlock);
    lastGroup=m[0];
  }
  const b=document.createElement("button");
  b.innerText=m[1];
  b.onclick=()=>addItem(m[1],m[2]);
  groupBlock.querySelector(".menu-items").appendChild(b);
});

/* ===== PH·∫¶N C√íN L·∫†I GI·ªÆ NGUY√äN 100% ===== */
/* (kh√¥ng s·ª≠a th√™m ƒë·ªÉ tr√°nh sai) */

function save(){localStorage.setItem("orders",JSON.stringify(orders));localStorage.setItem("history",JSON.stringify(history));localStorage.setItem("sold",JSON.stringify(sold));localStorage.setItem("takeaway",takeaway);}
const tablesDiv=document.getElementById("tables");
function renderTables(){tablesDiv.innerHTML="";tables.forEach(t=>{const b=document.createElement("button");b.className="table-btn";b.innerText=t;if(orders[t]?.length){const w=waitMin(t);if(w>=10)b.classList.add("danger");else if(w>=5)b.classList.add("warn");}if(current===t)b.classList.add("active");b.onclick=()=>select(t);tablesDiv.appendChild(b);});Object.keys(orders).forEach(t=>{if(t.startsWith("MV")){const b=document.createElement("button");b.className="table-btn warn";b.innerText=t;b.onclick=()=>select(t);tablesDiv.appendChild(b);}});}
const orderList=document.getElementById("orderList"),totalDiv=document.getElementById("total"),currentSpan=document.getElementById("current"),currentBox=document.getElementById("currentBox");
function select(t){current=t;render();}
function addItem(name,price){if(!current)return alert("Ch∆∞a ch·ªçn b√†n/ƒë∆°n");orders[current]=orders[current]||[];orders[current].push({name,price,done:false,time:Date.now()});save();render();}
function toggleDone(i){orders[current][i].done=!orders[current][i].done;save();render();}
function delItem(i){orders[current].splice(i,1);save();render();}
function waitMin(t){const p=(orders[t]||[]).filter(o=>!o.done);if(!p.length)return 0;return Math.floor((Date.now()-p[0].time)/60000);}
function render(){orderList.innerHTML="";let sum=0,oldest=Infinity,oi=-1;(orders[current]||[]).forEach((o,i)=>{if(!o.done&&o.time<oldest){oldest=o.time;oi=i}});(orders[current]||[]).forEach((o,i)=>{sum+=o.price;const li=document.createElement("li");if(o.done)li.classList.add("done");if(i===oi&&!o.done)li.classList.add("longest");li.innerHTML=`<div class="order-left">${i+1}. <input type="checkbox"${o.done?" checked":""} onchange="toggleDone(${i})"> ${o.name} <span class="del" onclick="delItem(${i})">‚ùå</span></div><div>${o.price.toLocaleString()}ƒë</div>`;orderList.appendChild(li);});currentSpan.innerText=current||"---";currentBox.innerText=current||"---";totalDiv.innerText=sum.toLocaleString()+" ƒë";renderActive();renderHistory();renderTables();}
const activeList=document.getElementById("activeList");
function renderActive(){activeList.innerHTML="";Object.keys(orders).forEach(t=>{if(!orders[t].length)return;const sum=orders[t].reduce((a,b)=>a+b.price,0);activeList.innerHTML+=`<li onclick="select('${t}')">${t} | ‚è±Ô∏è ${waitMin(t)}p | üí∞ ${sum.toLocaleString()}ƒë</li>`;});}
function pay(){if(!current)return;lastPay={table:current,items:[...orders[current]]};history.unshift({table:current,time:new Date().toLocaleTimeString(),items:[...orders[current]]});sold.push(...orders[current]);if(current.startsWith("MV"))delete orders[current];else orders[current]=[];current="";save();render();}
function undoPay(){if(!lastPay)return;orders[lastPay.table]=lastPay.items;current=lastPay.table;lastPay=null;save();render();}
const historyDiv=document.getElementById("history");
function renderHistory(){historyDiv.innerHTML="";history.forEach(h=>{const sum=h.items.reduce((a,b)=>a+b.price,0);historyDiv.innerHTML+=`<div><b>${h.time} ‚Äì ${h.table}</b><br>${h.items.map(i=>`${i.name} ${i.price.toLocaleString()}ƒë`).join("<br>")}<br><b>T·ªïng: ${sum.toLocaleString()}ƒë</b><hr></div>`;});}
function printBill(){if(!current)return alert("Ch∆∞a ch·ªçn b√†n/ƒë∆°n");let html=`<html><head><meta charset="UTF-8"><style>body{font-family:Arial;padding:20px}h2{text-align:center}.item{display:flex;justify-content:space-between;font-size:18px;margin:6px 0}.total{font-size:22px;font-weight:bold;margin-top:12px;text-align:right}</style></head><body><h2>H√ìA ƒê∆†N ${current}</h2>`;let sum=0;orders[current].forEach(o=>{sum+=o.price;html+=`<div class="item"><span>${o.name}</span><span>${o.price.toLocaleString()}ƒë</span></div>`;});html+=`<div class="total">T·ªîNG: ${sum.toLocaleString()}ƒë</div><script>window.print();window.onafterprint=()=>window.close();<\/script></body></html>`;const w=window.open("","_blank");w.document.write(html);w.document.close();}
function showStats(){
  if(!sold || sold.length === 0){
    showPopup("<h2>Ch∆∞a c√≥ d·ªØ li·ªáu trong ng√†y</h2>");
    return;
  }

  let total = 0;
  let map = {};

  sold.forEach(item=>{
    if(!map[item.name]){
      map[item.name] = {qty:0, money:0};
    }
    map[item.name].qty++;
    map[item.name].money += item.price;
    total += item.price;
  });

  let html = "<h2>TH·ªêNG K√ä NG√ÄY</h2>";

  for(const name in map){
    html += `<div>${name}: ${map[name].qty} ‚Üí ${map[name].money.toLocaleString()}ƒë</div>`;
  }

  html += `<hr><h1>T·ªîNG DOANH THU: ${total.toLocaleString()}ƒë</h1>`;

  showPopup(html);
}



function exportExcel(){if(!history.length){alert("Ch∆∞a c√≥ d·ªØ li·ªáu");return;}let summary={},rows1=[["M√≥n","S·ªë l∆∞·ª£ng","T·ªïng ti·ªÅn"]];sold.forEach(i=>{summary[i.name]=summary[i.name]||{q:0,t:0};summary[i.name].q++;summary[i.name].t+=i.price;});Object.keys(summary).forEach(k=>{rows1.push([k,summary[k].q,summary[k].t]);});let rows2=[["Th·ªùi gian","B√†n","M√≥n","Gi√°"]];history.forEach(h=>{h.items.forEach(i=>{rows2.push([h.time,h.table,i.name,i.price]);});});const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows1),"TongHop");XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows2),"DonHang");XLSX.writeFile(wb,`order-${new Date().toISOString().slice(0,10)}.xlsx`);}
function closeDay(){if(!confirm("Ch·ªët cu·ªëi ng√†y?"))return;orders={};history=[];sold=[];takeaway=0;save();render();}
function addTakeaway(){takeaway++;const id="MV"+String(takeaway).padStart(2,"0");orders[id]=[];save();select(id);}
function showPopup(html){
  const overlay = document.getElementById("overlay");
  const content = document.getElementById("popupContent");

  content.innerHTML = html;
  overlay.style.display = "flex";

  console.log("Popup opened"); // ƒë·ªÉ ch·∫Øc ch·∫Øn
}

function closePopup(){document.getElementById("overlay").style.display="none";}
renderTables();render();setInterval(renderTables,60000);
document.addEventListener('gesturestart', function (e) {
  e.preventDefault();
});

</script>

</body>
</html>
